---
title: "Supplementary Figure proposals"
output:
  pdf_document: default
  html_notebook: default
---

This is a sketch of an alternative default threshold which is in accordance with the parameters for $\lambda$ and $\mu$, birth and death rates for duplication events, inferred from the mixture model. In that model, $\lambda = 2.9634860$, and $\mu = 0.0789256$. The intersection point from that model was 0.009 in units of time, giving a threshold of approximately 0.02 in units of expected numbers of substitution.

How this would differ from how we originally laid out treeinform and the supplementary material:

* $\lambda$ and $\mu$ rates would come from the mixture model inference. In the original supplementary information, $\lambda$ and $\mu$ rates came from a program called CAFE3, which was run on the set of gene trees pre-treeinform.

* The default threshold would change from 0.05 to 0.02 based on the back-calibration of the threshold from the mixture model. The mixture model would serve as the justification for the default threshold. In the original supplementary information, 0.05 was chosen based on an analysis of subtree lengths for internal nodes with multiple descendants from the same species.

* Figure 3b and Table 3c would change. We would plot the theoretical pdf of duplication times using $\lambda$ and $\mu$ from the mixture model. With this change, Table 3c shows that using 0.02 as a threshold brings us closest to the theoretical cdf of duplication times. In the original supplementary information, Table 3c showed that using 0.05 as a threshold brought us closest to the theoretical cdf of duplication times. Figure 3b and Table 3c were also used as validation for the selection of 0.05 as a threshold.

One drawback of this is that the birth ($\lambda$) and death ($\mu$) rates inferred from the mixture model don't seem realistic. The birth rate is very high and the death rate is very low. This suggests that the mixture model was still skewed by the presence of what are likely transcript assignment errors, i.e. transcripts belonging to the same gene being assigned to different genes.

One thing we could do is rerun the mixture model with different initial gamma parameters (we used a gamma distribution to model transcripts belonging to the same gene being assigned to different genes) that have a larger area under the curve, or rerun the mixture model with bounds on the birth and death rates.

Below is a view of how Figure 3b and Table 3c would change. These analyses were done with phyldog run on gene trees from the 7taxa Siphonophora dataset after treeinform with threshold=0.025, as I am currently running Agalma1.0 with treeinform threshold=0.02 and waiting on the results.

```{r, setup, include=FALSE}
library(ape)
library(ggplot2)
library(dplyr)
library(hutan)
library(treeio)
library(parallel)
library(knitr)
library(runjags)

cores = detectCores()
if (cores < 1) { cores = 1 }
set.seed(1287234)

source("code/functions.R")
```

```{r, parse_trees, include=FALSE, warnings=FALSE}
# Parse trees before everything else
# make speciation calibration times (taken from chronos)
age <- c(0.1718036, 0.1430510, 0.2490215, 0.3227746, 0.5157844, 1.0000000)
clade <- c("Calycophora", "Agalmatidae", "Chodorophora", "Siphonophora", "Hydrozoa", "Cnidaria")
calibration_times = data.frame(age, clade, stringsAsFactors = FALSE)

#5299 gene trees + 5301 (missing 5300)
s <- 1:260
#before <- dt_phyldog(s, "data/before/", calibration_times)
#trees_before <- before[[1]]
#calibrated_before <- before[[2]]
#dt_before <- before[[3]]
#save(dt_before, file="data/dt_before.Rdata")
#save(trees_before, file="data/trees_before.Rdata")
#save(calibrated_before, file="data/calibrated_before.Rdata")
load("data/dt_before.Rdata")
load("data/trees_before.Rdata")
load("data/calibrated_before.Rdata")

#k <- 7000:7300
#threshold_5 <- dt_phyldog(k, "data/threshold-5/", calibration_times)
#save(threshold_5, file="data/dt_threshold-5.Rdata")[[3]]
load("data/dt_threshold-5.Rdata")

#l <- 27804:28104
#threshold_2 <- dt_phyldog(l, "data/threshold-2/", calibration_times)
#save(threshold_2, file="data/dt_threshold-2.Rdata")[[3]]
load("data/dt_threshold-2.Rdata")

#threshold_8 <- dt_phyldog(l, "data/threshold-8/", calibration_times)[[3]]
#save(threshold_8, file="data/dt_threshold-8.Rdata")
load("data/dt_threshold-8.Rdata")

#threshold_mix <- dt_phyldog(l, "data/threshold-mix/", calibration_times)[[3]]
#save(threshold_mix, file="data/dt_threshold-mix.Rdata")
load("data/dt_threshold-0.025.Rdata")
```

# Figure 3b
```{r, fig2b, echo=FALSE}
dt <- c(dt_before, threshold_5, threshold_2, threshold_0.025)
l1 = length(dt_before)
l2 = length(threshold_5)
l3 = length(threshold_2)
l4 = length(threshold_0.025)
Threshold <- rep(NA, l1+l2+l3+l4)
Threshold[1:l1] <- "Before"
Threshold[l1+1:l2] <- "0.05"
Threshold[l1+l2+1:l3] <- "50"
Threshold[l1+l2+l3+1:l4] <- "0.025"
data = data.frame(dt, Threshold)
f = function(x) dup_pdf(x, 1, 2.9634860, 0.0789256)
ggplot(data, aes(dt)) + geom_density(aes(group=Threshold, color=Threshold)) + stat_function(fun=f) + ggtitle("Density of inferred and theoretical duplication times\nunder different treeinform thresholds") + xlab("Duplication Times") + ylab("Density") + theme_classic()
```

# Table 3c

```{r, ks, echo=FALSE}
theoretical = function(x) dup_cdf(x, 1, 2.9634860, 0.0789256)
ks.stat <- c(ks.test(dt_before, theoretical)$statistic, ks.test(threshold_2, theoretical)$statistic, ks.test(threshold_5, theoretical)$statistic, ks.test(threshold_0.025, theoretical)$statistic)
ks.pval <- c(ks.test(dt_before, theoretical)$p.value, ks.test(threshold_2, theoretical)$p.value, ks.test(threshold_5, theoretical)$p.value, ks.test(threshold_0.025, theoretical)$p.value)
ks <- data.frame(ks.stat, ks.pval)
colnames(ks) <- c("Statistic", "P-Value")
rownames(ks) <- c("Before", "50", "0.05", "0.025")
kable(ks)
```